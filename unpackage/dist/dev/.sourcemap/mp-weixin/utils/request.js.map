{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["// import store from '@/store'\r\nimport config from '@/config'\r\nimport { getToken } from '@/utils/auth'\r\nimport errorCode from '@/utils/errorCode'\r\nimport { toast, showConfirm, tansParams } from '@/utils/common'\r\n\r\nlet timeout = 10000\r\nconst baseUrl = config.baseUrl\r\n\r\n\r\nconst request = config => {\r\n  // 是否需要设置 token\r\n  const isToken = (config.header || {}).isToken === false;\r\n  config.header = config.header || {};\r\n  if (getToken() && !isToken) {\r\n    config.header['Authorization'] = getToken();\r\n  }\r\n  // get请求映射params参数\r\n  if (config.params) {\r\n    let url = config.url + '?' + tansParams(config.params);\r\n    url = url.slice(0, -1);\r\n    config.url = url;\r\n  }\r\n  return new Promise((resolve, reject) => {\r\n    uni.request({\r\n      method: config.method || 'get',\r\n      timeout: config.timeout || timeout,\r\n      url: config.baseUrl ? config.baseUrl + config.url : baseUrl + config.url,\r\n      data: config.data,\r\n      header: config.header,\r\n      dataType: 'json'\r\n    })\r\n      .then(resArr => {\r\n        // 兼容 uni.request Promise 返回格式：[error, res]\r\n        let error, res;\r\n        if (Array.isArray(resArr)) {\r\n          [error, res] = resArr;\r\n        } else {\r\n          // HBuilderX 3.7+ 可能直接返回 res\r\n          error = null;\r\n          res = resArr;\r\n        }\r\n        if (error) {\r\n          reject('后端接口连接异常');\r\n          return;\r\n        }\r\n        if (!res || !res.data) {\r\n          reject('无响应数据');\r\n          return;\r\n        }\r\n        const code = res.data.code || 200;\r\n        const msg = errorCode[code] || res.data.msg || res.data.message || errorCode['default'];\r\n        if (res.data == \"404 page not found\") {\r\n          reject('404 page not found');\r\n          toast('404 page not found');\r\n          return;\r\n        }\r\n        if (code === 401) {\r\n          showConfirm('登录状态已过期，您可以继续留在该页面，或者重新登录?').then(res => {\r\n            if (res.confirm) {\r\n              // 这里可加登出逻辑\r\n            }\r\n          });\r\n          reject('无效的会话，或者会话已过期，请重新登录。');\r\n        } else if (code === 500) {\r\n          reject('500');\r\n        } else if (code !== \"SUCCESS\" && code !== 200) {\r\n          toast(msg);\r\n          reject(code.message || msg || code);\r\n        } else {\r\n          resolve(res.data);\r\n        }\r\n      })\r\n      .catch(error => {\r\n        let message = error && error.message ? error.message : String(error);\r\n        if (message === 'Network Error') {\r\n          message = '后端接口连接异常';\r\n        } else if (message.includes('timeout')) {\r\n          message = '系统接口请求超时';\r\n        } else if (message.includes('Request failed with status code')) {\r\n          message = '系统接口' + message.substr(message.length - 3) + '异常';\r\n        }\r\n        toast(message);\r\n        reject(error);\r\n      });\r\n  });\r\n};\r\n\r\nexport default request\r\n"],"names":["config","getToken","tansParams","uni","errorCode","toast","showConfirm","res"],"mappings":";;;;;;AAMA,IAAI,UAAU;AACd,MAAM,UAAUA,OAAM,OAAC;AAGlB,MAAC,UAAU,CAAAA,YAAU;AAExB,QAAM,WAAWA,QAAO,UAAU,CAAE,GAAE,YAAY;AAClD,EAAAA,QAAO,SAASA,QAAO,UAAU,CAAA;AACjC,MAAIC,WAAQ,SAAA,KAAM,CAAC,SAAS;AAC1B,IAAAD,QAAO,OAAO,eAAe,IAAIC,WAAQ,SAAA;AAAA,EAC1C;AAED,MAAID,QAAO,QAAQ;AACjB,QAAI,MAAMA,QAAO,MAAM,MAAME,wBAAWF,QAAO,MAAM;AACrD,UAAM,IAAI,MAAM,GAAG,EAAE;AACrB,IAAAA,QAAO,MAAM;AAAA,EACd;AACD,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtCG,kBAAAA,MAAI,QAAQ;AAAA,MACV,QAAQH,QAAO,UAAU;AAAA,MACzB,SAASA,QAAO,WAAW;AAAA,MAC3B,KAAKA,QAAO,UAAUA,QAAO,UAAUA,QAAO,MAAM,UAAUA,QAAO;AAAA,MACrE,MAAMA,QAAO;AAAA,MACb,QAAQA,QAAO;AAAA,MACf,UAAU;AAAA,IAChB,CAAK,EACE,KAAK,YAAU;AAEd,UAAI,OAAO;AACX,UAAI,MAAM,QAAQ,MAAM,GAAG;AACzB,SAAC,OAAO,GAAG,IAAI;AAAA,MACzB,OAAe;AAEL,gBAAQ;AACR,cAAM;AAAA,MACP;AACD,UAAI,OAAO;AACT,eAAO,UAAU;AACjB;AAAA,MACD;AACD,UAAI,CAAC,OAAO,CAAC,IAAI,MAAM;AACrB,eAAO,OAAO;AACd;AAAA,MACD;AACD,YAAM,OAAO,IAAI,KAAK,QAAQ;AAC9B,YAAM,MAAMI,gBAAS,UAAC,IAAI,KAAK,IAAI,KAAK,OAAO,IAAI,KAAK,WAAWA,gBAAS,UAAC,SAAS;AACtF,UAAI,IAAI,QAAQ,sBAAsB;AACpC,eAAO,oBAAoB;AAC3BC,qBAAK,MAAC,oBAAoB;AAC1B;AAAA,MACD;AACD,UAAI,SAAS,KAAK;AAChBC,qBAAAA,YAAY,4BAA4B,EAAE,KAAK,CAAAC,SAAO;AACpD,cAAIA,KAAI;AAAS;AAAA,QAG7B,CAAW;AACD,eAAO,sBAAsB;AAAA,MACvC,WAAmB,SAAS,KAAK;AACvB,eAAO,KAAK;AAAA,MACb,WAAU,SAAS,aAAa,SAAS,KAAK;AAC7CF,qBAAK,MAAC,GAAG;AACT,eAAO,KAAK,WAAW,OAAO,IAAI;AAAA,MAC5C,OAAe;AACL,gBAAQ,IAAI,IAAI;AAAA,MACjB;AAAA,IACT,CAAO,EACA,MAAM,WAAS;AACd,UAAI,UAAU,SAAS,MAAM,UAAU,MAAM,UAAU,OAAO,KAAK;AACnE,UAAI,YAAY,iBAAiB;AAC/B,kBAAU;AAAA,MACX,WAAU,QAAQ,SAAS,SAAS,GAAG;AACtC,kBAAU;AAAA,MACX,WAAU,QAAQ,SAAS,iCAAiC,GAAG;AAC9D,kBAAU,SAAS,QAAQ,OAAO,QAAQ,SAAS,CAAC,IAAI;AAAA,MACzD;AACDA,mBAAK,MAAC,OAAO;AACb,aAAO,KAAK;AAAA,IACpB,CAAO;AAAA,EACP,CAAG;AACH;;"}